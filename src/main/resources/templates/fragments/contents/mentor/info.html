<!DOCTYPE html>
<html lang="ko"
      layout:decorate="~{layout/default}"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
>
<head>
  <title>Anchor-service</title>
  <script src="/js/library/jquery/jquery-3.7.1.min.js"></script>
</head>

<div class="main" layout:fragment="content">
  <h2 class="text-center">멘토 정보 페이지</h2>

  <div class="container mt-3" style="max-width: 100%">
    <hr>
    <div class="row">
      <div class="col-md-2">
        <div th:if="${session.user != null && mentorInfo.id eq session.user.mentorId}">
          <div th:replace="~{fragments/sidebar :: sidebar}"></div>
        </div>
      </div>

      <!-- [좌측] 멘토 소개글 및 멘토링 목록  시작-->
      <div class="col-md-7">
        <form>
          <!--멘토 소개글-->
          <div class="form-group">
            <p>멘토 소개</p>
            <div class="border border-3 shadow-sm p-3 mb-5 bg-body rounded" id="viewer">
              <!--          Contents 들어갈 자리-->
            </div>
            <a class="btn btn-success mt-3"
               th:href="@{/mentors/me/introduction}"
               th:if="${session.user ne null && mentorInfo.id eq session.user.mentorId && mentorInfo.mentorIntroduction ne null}">
              멘토 소개글 수정</a>
            <a class="btn btn-success mt-3"
               th:href="@{/mentors/me/introduction}"
               th:if="${session.user ne null && mentorInfo.id eq session.user.mentorId && mentorInfo.mentorIntroduction eq null}">
              멘토 소개글 작성</a>
          </div>

          <!--멘토링 목록-->
          <div class="form-group mt-4">
            <label for="mentoringList" style="font-size: 20px; text-align: center; font-weight: bold;">멘토링 목록</label>
            <div class="row" id="mentoringList">
              <div class="col-md-4 mb-4" th:each="mentorings, iterStat : ${mentorInfo.mentorings}">
                <div class="card mt-2">
                  <div class="card-body">
                    <h5 class="card-title" th:text="${mentorings.title}">멘토링 주제</h5>

                    <div class="form-group row">
                      <label class="col-sm-3 col-form-label" for="durationTime" style="color: #808080;">시간</label>
                      <div class="col-sm-9">
                        <span class="form-control-plaintext text-start" id="durationTime" name="durationTime"
                              th:text="${mentorings.durationTime}">1시간</span>
                      </div>
                    </div>
                    <div class="form-group row">
                      <label class="col-sm-3 col-form-label" for="cost" style="color: #808080;">비용</label>
                      <div class="col-sm-9">
                        <span class="form-control-plaintext text-start" id="cost" name="cost"
                              th:text="${mentorings.cost} + '원'">1만원</span>
                      </div>
                    </div>
                    <a class="btn btn-primary mt-3" th:href="@{/mentorings/{id}(id=${mentorings.id})}">상세 보기</a>
                    <button class="btn btn-danger mt-3"
                            id="btn-mentoring-delete"
                            th:if="${session.user != null && mentorInfo.id eq session.user.mentorId}" type="button">멘토링
                      삭제
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </form>
      </div>
      <!-- [좌측] 멘토 소개글 및 멘토링 목록  끝-->

      <!-- [우측] 멘토 정보 시작 -->
      <div class="col-md-3 text-center">
        <!--방문자, 멘티, 다른 멘토 페이지-->
        <div class="card">
          <div class="card-header">멘토 정보</div>
          <div class="mt-3" id="current-profile-image">
            <div class="profile">
              <img alt="" src="/images/x.png" th:if="${mentorInfo.user.image eq null}" width="200px">
              <img alt="" th:src="${mentorInfo.user.image}" th:unless="${mentorInfo.user.image eq null}" width="200px">
            </div>
          </div>
          <div class="card-body">
            <hr>
            <!--닉네임-->
            <div class="form-group row justify-content-center">
              <label class="col-sm-4 col-form-label text-end" for="nickname" style="color: #808080;">닉네임</label>
              <div class="col-sm-8">
                <span class="form-control-plaintext text-start" id="nickname" name="nickname"
                      th:text="${mentorInfo.user.nickname}"></span>
              </div>
            </div>
            <!--회사 계정-->
            <div class="form-group row justify-content-center">
              <label class="col-sm-4 col-form-label text-end" for="companyEmail" style="color: #808080;">회사 계정</label>
              <div class="col-sm-8">
                <span class="form-control-plaintext text-start" id="companyEmail" name="companyEmail"
                      th:text="${mentorInfo.companyEmail}"></span>
              </div>
            </div>
            <!--커리어-->
            <div class="form-group row justify-content-center">
              <label class="col-sm-4 col-form-label text-end" for="current-career" style="color: #808080;">연차</label>
              <div class="col-sm-8">
                <span class="form-control-plaintext text-start" id="current-career" name="current-career"
                      th:text="${mentorInfo.career} +' (' + ${mentorInfo.career.rangeOfYear} +')'"></span>
              </div>
            </div>
          </div>
        </div>

        <!--멘토 + 자신의 페이지-->
        <div class="card mt-3" th:if="${session.user != null and mentorInfo.id eq session.user.mentorId}">
          <div class="card-header">멘토 필수정보</div>
          <div class="card-body">
            <!--커리어-->
            <div class="form-group row justify-content-center">
              <label class="col-sm-4 col-form-label text-end" for="career" style="color: #808080;">연차</label>
              <div class="col-sm-8">
                <select class="form-control" id="career" name="career">
                  <option value=''>-선택-</option>
                  <option th:each="career : ${careers}"
                          th:selected="${career eq mentorInfo.career}"
                          th:text="${career.name} +' (' + ${career.rangeOfYear} + ')'"
                          th:value="${career.name}">
                    Select Career
                  </option>
                </select>
              </div>
            </div>

            <!--은행명-->
            <div class="form-group row justify-content-center">
              <label class="col-sm-4 col-form-label text-end" for="bankName" style="color: #808080;">은행명</label>
              <div class="col-sm-8">
                <select class="form-control" id="bankName" name="bankName">
                  <option value=''>-선택-</option>
                  <option th:each="bankCode : ${bankCodes}" th:selected="${bankCode.bankName eq mentorInfo.bankName}"
                          th:text="${bankCode.bankName}" th:value="${bankCode.bankName}"></option>
                </select>
              </div>
            </div>

            <!--계좌 번호-->
            <div class="form-group row justify-content-center">
              <label class="col-sm-4 col-form-label text-end" for="accountNumber" style="color: #808080;">계좌
                번호</label>
              <div class="col-sm-8">
                <input class="form-control" id="accountNumber" name="accountNumber"
                       th:value="${mentorInfo.accountNumber}"
                       type="text">
              </div>
            </div>

            <!--계좌 소유주 이름-->
            <div class="form-group row justify-content-center">
              <label class="col-sm-4 col-form-label text-end" for="accountName" style="color: #808080;">계좌 소유주</label>
              <div class="col-sm-8">
                <input class="form-control" id="accountName" name="accountName" th:value="${mentorInfo.accountName}"
                       type="text">
              </div>
            </div>
            <div>
              <button class="btn btn-outline-success mt-3" id="btn-mentor-update" type="button">수정하기</button>
              <button class="btn btn-outline-danger mt-3" id="btn-mentor-delete" type="button">멘토 권한 해제하기</button>
            </div>
          </div>
        </div>
      </div>
      <!-- [우측] 멘토 정보 끝 -->


    </div>
  </div>
  <script src="/js/library/toast/toastui-editor-all.min.js"></script>
  <script th:inline="javascript">
    const viewer = new toastui.Editor.factory({
      el: document.getElementById('viewer'), // toast ui editor 적용할 div
      viewer: true, // viewer 사용 여부
      initialValue: [[${mentorInfo.mentorIntroduction}]] //초기 입력값
    });

    let index = {
      init: function () {
        $("#btn-mentor-update").on("click", () => {
          this.updateMentor();
        });
        $("#btn-mentor-delete").on("click", () => {
          this.deleteMentor();
        });
        $("#btn-mentoring-delete").on("click", () => {
          this.deleteMentoring();
        });
      },

      /*정보 수정*/
      updateMentor: function () {
        let data = {
          career: $("#career").val(),
          bankName: $("#bankName").val(),
          accountNumber: $("#accountNumber").val(),
          accountName: $("#accountName").val()
        };
        $.ajax({
          type: "put",
          url: "/mentors/me/info",
          data: JSON.stringify(data),
          contentType: "application/json; charset=utf-8",
        }).done(function (resp) {
          if (resp.status === 500) {
            alert("멘토 필수 정보 수정을 실패했습니다.");
          } else {
            alert("멘토 필수 정보 수정을 성공했습니다.");
            window.location.reload();
          }
        }).fail(function (error) {
          alert(JSON.stringify(error));
        });
      },
      /*멘토 권한 해제*/
      deleteMentor: function () {
        let data = {
          mentorId: [[${mentorInfo.id}]]
        };
        $.ajax({
          type: "delete",
          url: "/mentors/me",
          data: JSON.stringify(data),
          contentType: "application/json; charset=utf-8",
        }).done(function (resp) {
          if (resp.status === 500) {
            alert("멘토 권한 해제 실패");
            window.location.reload();
          } else {
            alert("멘토 권한 해제 성공");
            location.href = "/";
          }
        }).fail(function (error) {
          alert("멘토링 목록을 모두 삭제 후 멘토 권한 해제가 가능합니다.");
          window.location.reload();
        });
      },
      /*멘토링 삭제*/
      deleteMentoring: function () {
        console.log("click");
      },
    }

    index.init();
  </script>
</div>

</html>